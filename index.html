<script src="http://192.168.120.230:6742/socket.io/socket.io.js"></script>
<style>
    .blackboard {
        height: 500px;
        width: 500px;
        float: left;
        background-color: lightblue;
    }

    .result {
        height: 500px;
        width: 500px;
        float: right;
        background-color: lightgreen;
        overflow: scroll;
    }
</style>
<script>
    window.addEventListener('DOMContentLoaded', function () {

        // var socket = io.connect("http://192.168.120.230:6742");
        var socket = io("http://192.168.120.230:6742");
        //<debug>
        var sendData = null;
        var lastValue = '';
        //</debug>

        socket.on('news', function (data) {
            console.log(data);
            // socket.emit("my othet event", { my: 'data' });
        });

        socket.on("hints", function (data) {
            renderData(data);
        });

        var resultElement = document.getElementsByClassName("results")[0],
            blackboradElement = document.getElementById("editor"),
            indexElement = document.getElementById('index'),
            /**
            * renderData dibujar los resultados
            * @private
            */
            renderData = function (data) {
                rawdata = data.records || [];
                //<debug>

                var times = new Date().getTime() - sendData;
                console.log('records:', rawdata.length, 'time (ms):', times);
                //</debug>
                var results = '';

                // resultElement.innerHTML = '';

                var rawdata = rawdata || [];
                var length = rawdata.length > 50 ? 50 : rawdata.length;
                for (var index = 0; index < length; index++) {
                    var element = rawdata[index];
                    var final = highlighter(element.v, lastValue);
                    results += '<li>' + final + '</ul>';
                }
                resultElement.innerHTML = results;
            },
            /**
             * searchValue buscar coinsidencias en el servidor
             * @private
             */
            searchValue = function (value) {
                //<debug>
                sendData = new Date().getTime()
                //</debug>
                lastValue = value;
                socket.emit("search", { value: value, index: indexElement.value })
            },
            /**
             * @method searchOnWebService call rest web service
             * @return {Array} rawdata `[]` data response to web service
             * @private
             */
            searchOnWebService = function () {
                var rawdata = [];

                return rawdata;
            };
        // var
        //     clone = function (array) {
        //         return slice.call(array);
        //     },
        //     merge = function (destination) {
        //         var i = 1,
        //             ln = arguments.length,
        //             mergeFn = merge,
        //             cloneFn = clone,
        //             object, key, value, sourceKey;

        //         for (; i < ln; i++) {
        //             object = arguments[i];

        //             for (key in object) {
        //                 value = object[key];
        //                 if (value && value.constructor === Object) {
        //                     sourceKey = destination[key];
        //                     if (sourceKey && sourceKey.constructor === Object) {
        //                         mergeFn(sourceKey, value);
        //                     } else {
        //                         destination[key] = cloneFn(value);
        //                     }
        //                 } else {
        //                     destination[key] = value;
        //                 }
        //             }
        //         }

        //         return destination;
        //     },
        //     isArray = function (value) {
        //         return toString.call(value) === '[object Array]';
        //     };
        // var highlight = function (doc) {
        //     "use strict";
        //     var defaults = {
        //         node: null,
        //         pattern: null,
        //         tagName: "strong",
        //         className: null,
        //         wordsOnly: false,
        //         caseSensitive: false
        //     };
        //     return function hightlight(o) {
        //         var regex;
        //         // o = _.mixin({}, defaults, o);
        //         o = merge({}, defaults, o);
        //         if (!o.node || !o.pattern) {
        //             return;
        //         }
        //         o.pattern = isArray(o.pattern) ? o.pattern : [o.pattern];
        //         regex = getRegex(o.pattern, o.caseSensitive, o.wordsOnly);
        //         traverse(o.node, hightlightTextNode);
        //         function hightlightTextNode(textNode) {
        //             var match, patternNode, wrapperNode;
        //             if (match = regex.exec(textNode.data)) {
        //                 wrapperNode = doc.createElement(o.tagName);
        //                 o.className && (wrapperNode.className = o.className);
        //                 patternNode = textNode.splitText(match.index);
        //                 patternNode.splitText(match[0].length);
        //                 wrapperNode.appendChild(patternNode.cloneNode(true));
        //                 textNode.parentNode.replaceChild(wrapperNode, patternNode);
        //             }
        //             return !!match;
        //         }
        //         function traverse(el, hightlightTextNode) {
        //             var childNode, TEXT_NODE_TYPE = 3;
        //             for (var i = 0; i < el.childNodes.length; i++) {
        //                 childNode = el.childNodes[i];
        //                 if (childNode.nodeType === TEXT_NODE_TYPE) {
        //                     i += hightlightTextNode(childNode) ? 1 : 0;
        //                 } else {
        //                     traverse(childNode, hightlightTextNode);
        //                 }
        //             }
        //         }
        //     };
        //     function getRegex(patterns, caseSensitive, wordsOnly) {
        //         var escapedPatterns = [], regexStr;
        //         for (var i = 0, len = patterns.length; i < len; i++) {
        //             escapedPatterns.push(_.escapeRegExChars(patterns[i]));
        //         }
        //         regexStr = wordsOnly ? "\\b(" + escapedPatterns.join("|") + ")\\b" : "(" + escapedPatterns.join("|") + ")";
        //         return caseSensitive ? new RegExp(regexStr) : new RegExp(regexStr, "i");
        //     }
        // } (window.document);
        highlighter = function (item, query) {
            query = query || this.query;
            query = query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&');
            return item.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
                return '<strong>' + match + '</strong>'
            })
        }
        blackboradElement.onkeyup = function () {
            var value = this.value;
            if (value) {
                //<debug>
                console.log('search', value);
                //</debug>
                searchValue(value);
            }
        };
    }, true);

</script>
<!--<div class="blackboard" contenteditable="true"></div>-->
<textarea id="editor" rows="12" cols="80"></textarea>
<div class="result">
    <ol class="results"> </ol>
</div>
<div class="total"></div>
<label for="index">No. Index:</label>
<select id="index">
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
</select>

<button onclick="searchOnWebService"> call rest </button>